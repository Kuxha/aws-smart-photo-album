<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Photo Album</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="./lib/CryptoJS/rollups/crypto-js.js"></script>

    <script src="./lib/CryptoJS/rollups/sha256.js"></script>
    <script src="./lib/CryptoJS/components/hmac.js"></script>
    <script src="./lib/CryptoJS/components/enc-base64.js"></script>

    <script src="./lib/axios/dist/axios.standalone.js"></script>
    <script src="./lib/url-template/url-template.js"></script>
    <script src="./lib/apiGatewayCore/sigV4Client.js"></script>
    <script src="./lib/apiGatewayCore/apiGatewayClient.js"></script>
    <script src="./lib/apiGatewayCore/simpleHttpClient.js"></script>
    <script src="./lib/apiGatewayCore/utils.js"></script>

    <script src="./apigClient.js"></script>

    <script>
        tailwind.config = {
            theme: { extend: { animation: { 'spin-slow': 'spin 3s linear infinite' } } }
        }
    </script>
</head>

<body class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 min-h-screen p-8 font-sans text-gray-800">

    <div
        class="max-w-5xl mx-auto bg-white/40 backdrop-blur-xl border border-white/50 shadow-2xl rounded-3xl p-8 md:p-12">

        <div class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white drop-shadow-lg tracking-tight mb-2">
                ðŸ“¸ Smart Album
            </h1>
            <p class="text-white/90 text-lg font-medium">AI-Powered Search & Discovery</p>
        </div>

        <div class="bg-white/70 rounded-2xl p-6 mb-8 shadow-md hover:shadow-xl transition-all duration-300">
            <h3 class="text-xl font-bold text-indigo-900 mb-4 flex items-center">
                Upload Memory
            </h3>
            <div class="flex flex-col md:flex-row gap-4">
                <input type="file" id="fileInput" accept="image/*"
                    class="file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200 block w-full text-sm text-slate-500 bg-white rounded-xl border border-gray-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">

                <input type="text" id="customLabels" placeholder="Tags (e.g. Vacation, Family)"
                    class="flex-1 px-4 py-2 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm">

                <button onclick="uploadPhoto()"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg transform hover:-translate-y-1 transition-all duration-200">
                    Upload
                </button>
            </div>
        </div>

        <div class="bg-white/70 rounded-2xl p-6 mb-8 shadow-md hover:shadow-xl transition-all duration-300">
            <h3 class="text-xl font-bold text-indigo-900 mb-4">Search Gallery</h3>
            <div class="flex flex-col md:flex-row gap-4 relative">
                <input type="text" id="searchQuery" placeholder="Try 'Show me dogs'..."
                    class="w-full px-6 py-4 text-lg rounded-full border-2 border-transparent focus:border-indigo-500 focus:ring-0 shadow-inner outline-none transition-all bg-white">

                <button onclick="searchPhotos()"
                    class="absolute right-2 top-2 bottom-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold px-8 rounded-full shadow-md transform hover:scale-105 transition-all">
                    Search
                </button>
            </div>
        </div>

        <div id="loading" class="hidden flex justify-center my-8">
            <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-white shadow-lg"></div>
        </div>

        <div id="results" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>

        <div id="empty-state" class="hidden text-center py-10">
            <p class="text-white text-xl font-medium drop-shadow-md">No photos found. Try a different search!</p>
        </div>
    </div>

    <script>
        // INITIALIZE SDK
        var apigClient = apigClientFactory.newClient();

        function searchPhotos() {
            var query = document.getElementById('searchQuery').value;
            var resultsDiv = document.getElementById('results');
            var spinner = document.getElementById('loading');
            var empty = document.getElementById('empty-state');

            resultsDiv.innerHTML = '';
            empty.classList.add('hidden');
            spinner.classList.remove('hidden');

            // SDK Call
            apigClient.searchGet({ "q": query }, {}, {})
                .then(function (result) {
                    spinner.classList.add('hidden');
                    var data = result.data;

                    if (!data || data.length === 0) {
                        empty.classList.remove('hidden');
                        return;
                    }

                    data.forEach(item => {
                        var card = document.createElement('div');
                        card.className = "group relative bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 cursor-pointer";

                        var img = document.createElement('img');
                        img.src = `https://${item.bucket}.s3.amazonaws.com/${item.objectKey}`;
                        img.className = "w-full h-64 object-cover transform group-hover:scale-110 transition-transform duration-500";

                        var overlay = document.createElement('div');
                        overlay.className = "absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4 translate-y-full group-hover:translate-y-0 transition-transform duration-300";

                        var labels = document.createElement('p');
                        labels.className = "text-white text-sm font-medium";
                        labels.innerText = item.labels ? item.labels.join(', ') : 'No labels';

                        overlay.appendChild(labels);
                        card.appendChild(img);
                        card.appendChild(overlay);
                        resultsDiv.appendChild(card);
                    });
                })
                .catch(function (error) {
                    spinner.classList.add('hidden');
                    console.error("SDK Error:", error);
                    alert("Search error. Check console.");
                });
        }

        function uploadPhoto() {
            var file = document.getElementById('fileInput').files[0];
            var customLabels = document.getElementById('customLabels').value;
            if (!file) { alert('Select a file first!'); return; }

            // SDK Binary Upload with Headers
            var params = {
                "item": file.name,
                "Content-Type": file.type,
                "x-amz-meta-customLabels": customLabels
            };
            var additionalParams = {
                headers: {
                    "Content-Type": file.type,
                    "x-amz-meta-customLabels": customLabels
                }
            };

            apigClient.photosItemPut(params, file, additionalParams)
                .then(function (result) {
                    alert("âœ… Photo Uploaded!");
                    document.getElementById('fileInput').value = '';
                    document.getElementById('customLabels').value = '';
                })
                .catch(function (error) {
                    console.log("SDK Binary quirk detected. Trying direct fetch fallback...");
                    // Robust Fallback
                    fetch(apigClient.config.endpoint + '/photos/' + file.name, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': file.type,
                            'x-amz-meta-customLabels': customLabels
                        },
                        body: file
                    }).then(res => {
                        if (res.ok) alert("âœ… Uploaded (Fallback)!");
                        else alert("Upload Failed");
                    });
                });
        }
    </script>
</body>

</html>